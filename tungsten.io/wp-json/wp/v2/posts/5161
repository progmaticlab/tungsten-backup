{"id":5161,"date":"2014-10-11T23:12:10","date_gmt":"2014-10-11T23:12:10","guid":{"rendered":"http:\/\/23.253.246.131\/?p=5161"},"modified":"2014-10-11T23:12:10","modified_gmt":"2014-10-11T23:12:10","slug":"contrail-and-network-namespace","status":"publish","type":"post","link":"https:\/\/tungsten.io\/contrail-and-network-namespace\/","title":{"rendered":"Contrail and Network Namespace"},"content":{"rendered":"<h5>1 Network Namespace<\/h5>\n<p>Network namespace is a feature of Linux kernel. A separate network stack can be created as a network namespace for an application to run on.<\/p>\n<p>Network namespace is one of basic technologies used by Linux Container (LXC) and Docker. The goal of this document is to walk you through a workflow to connect an application in netnamespace to be part of a Contrail Virtual network.<br \/>\n<span id=\"more-1635\"><\/span><\/p>\n<h5>2 Connect Network Namespace and Virtual Network<\/h5>\n<p>The application running in network namespace is similar as running on bare-metal server. Contrail has the capability to connect such application to a virtual network, so that it can connect to other virtual machines. Essentially, from Contrail point of view, a network namespace is the same as a virtual machine.<\/p>\n<p>Opencontrail-netns is a program to connect network namespace and virtual network in Contrail.<\/p>\n<p><a href=\"https:\/\/github.com\/pedro-r-marques\/opencontrail-netns\" target=\"_blank\">https:\/\/github.com\/pedro-r-marques\/opencontrail-netns<\/a><\/p>\n<p>Here is the workflow of script daemon_start.py.<\/p>\n<ol>\n<li>Create a virtual machine on an existing virtual network, virtual machine interface and IP address in Contrail. Virtual machine here is not the real virtual machine running in system. Creating those objects makes Contrail treat network namespace as the same as virtual machine.<\/li>\n<li>Create network namespace and virtual Ethernet device (veth) that is like a pipe. The interface on one end of veth is in network namespace, which is equivalent to the interface in virtual machine. The interface on another end of veth is in default namespace, which is like the tap interface. Configure MAC address for the interface in network namespace.<\/li>\n<li>Register interface in default namespace to vRouter.<\/li>\n<li>Configure address on the interface in network namespace.<\/li>\n<\/ol>\n<p>The script daemon_stop.py removes all configurations in the reversed order.<\/p>\n<h5>3 Demo with MySQL<\/h5>\n<p>Here is a demo to show how Contrail connects MySQL server in network namespace to virtual network, so it can be accessed from other virtual machine. This demo runs on Contrail 1.05 Ubuntu based compute node. The MySQL server will run in network namespace. A MySQL client will run in VM.<\/p>\n<p><img loading=\"lazy\" decoding=\"async\" class=\"size-full wp-image-5678 aligncenter\" src=\"http:\/\/www.opencontrail.org\/wp-content\/uploads\/2014\/10\/blogpost_july_23_2014_image1.png\" alt=\"blogpost_july_23_2014_image1\" width=\"477\" height=\"335\" data-id=\"5678\" \/><\/p>\n<ol>\n<li>Create virtual networks and VM.<\/li>\n<\/ol>\n<p>Create virtual networks \u201cdatabase\u201d and \u201cclient\u201d on Contrail Web UI.<\/p>\n<p>Create network policy to allow all traffic, attach the policy to virtual networks \u201cdatabase\u201d and \u201cclient\u201d.<\/p>\n<p>Launch VM \u201cclient\u201d on virtual network \u201cclient\u201d on OpenStack Web UI.<\/p>\n<ol start=\"2\">\n<li>Build and install opencontrail-netns package.<\/li>\n<\/ol>\n<p><a href=\"https:\/\/github.com\/pedro-r-marques\/opencontrail-netns\" target=\"_blank\">https:\/\/github.com\/pedro-r-marques\/opencontrail-netns<\/a><\/p>\n<p>Clone the code and build the package.<\/p>\n<pre><span style=\"font-family: 'courier new', courier;\"><code> $ git clone https:\/\/github.com\/pedro-r-marques\/opencontrail-netns.git\n $ cd opencontrail-netns\/\n $ python .\/setup.py sdist\n $ ls dist\n opencontrail-netns-0.1.tar.gz<\/code><\/span><\/pre>\n<p>Copy the package to compute node and install it.<\/p>\n<pre><span style=\"font-family: 'courier new', courier;\"><code> # tar xzf opencontrail-netns-0.1.tar.gz\n # cd opencontrail-netns-0.1\/\n # python setup.py install\n # ls \/usr\/local\/bin\/netns-daemon-start\n \/usr\/local\/bin\/netns-daemon-start<\/code><\/span><\/pre>\n<p>3. Install MySQL on compute node.<\/p>\n<pre><span style=\"font-family: 'courier new', courier;\"><code># apt-get install mysql-server<\/code><\/span><\/pre>\n<p>4. Initialize MySQL server to add user \u201ctony\u201d and allow the access.<\/p>\n<pre><span style=\"font-family: 'courier new', courier;\"><code> # mysql -uroot -ppassword\n mysql&gt; CREATE USER 'tony'@'%' IDENTIFIED BY 'password';\n mysql&gt; GRANT ALL PRIVILEGES ON *.* TO 'tony'@'%' WITH GRANT OPTION;\n mysql&gt; FLUSH PRIVILEGES;\n mysql&gt; quit\n # service mysql stop<\/code><\/span><\/pre>\n<p>5. Update \/etc\/mysql\/my.cnf.<\/p>\n<pre><span style=\"font-family: 'courier new', courier;\"><code> \/etc\/mysql# diff -u my.cnf.orig my.cnf\n --- my.cnf.orig\n +++ my.cnf\n @@ -44,7 +44,7 @@\n #\n # Instead of skip-networking the default is now to listen only on\n # localhost which is more compatible and is not less secure.\n -bind-address = 127.0.0.1\n +bind-address = 0.0.0.0\n #\n # * Fine Tuning\n #<\/code><\/span><\/pre>\n<p>6. Update \/etc\/init\/mysql.conf.<\/p>\n<pre><span style=\"font-family: 'courier new', courier;\"><code> \/etc\/init# diff -u mysql.conf.orig mysql.conf\n --- mysql.conf.orig\n +++ mysql.conf\n @@ -16,6 +16,8 @@\n kill timeout 300\n pre-start script\n + \/usr\/local\/bin\/netns-daemon-start -s 10.84.18.2 --network default-domain:demo:database mysql\n +\n #Sanity checks\n [ -r $HOME\/my.cnf ]\n [ -d \/var\/run\/mysqld ] || install -m 755 -o mysql -g root -d \/var\/run\/mysqld\n @@ -23,7 +25,9 @@\n LC_ALL=C BLOCKSIZE= df --portability \/var\/lib\/mysql\/. | tail -n 1 | awk '{ exit ($4&lt;4096) }'\n end script\n -exec \/usr\/sbin\/mysqld\n +exec ip netns exec ns-mysql \/usr\/sbin\/mysqld\n post-start script\n for i in `seq 1 30` ; do\n @@ -42,3 +46,7 @@\n done\n exit 1\n end script\n +\n +post-stop script\n + \/usr\/local\/bin\/netns-daemon-stop -s 10.84.18.2 mysql\n +end script<\/code><\/span><\/pre>\n<p>7. Start MySQL server.<\/p>\n<pre><span style=\"font-family: 'courier new', courier;\"><code># service mysql start<\/code><\/span><\/pre>\n<p>8.Connect to MySQL server from VM \u201cclient\u201d.<\/p>\n<pre><span style=\"font-family: 'courier new', courier;\"><code> [root@client ~]# mysql -h 192.168.10.252 -utony -ppassword\n Welcome to the MySQL monitor. Commands end with ; or \\g.\n Your MySQL connection id is 37\n Server version: 5.5.34-0ubuntu0.12.04.1 (Ubuntu)\n Copyright (c) 2000, 2013, Oracle and\/or its affiliates. All rights reserved.\n Oracle is a registered trademark of Oracle Corporation and\/or its\n affiliates. Other names may be trademarks of their respective\n owners.\n Type 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.\n mysql&gt;<\/code><\/span><\/pre>\n<h5>4\u00a0Step by Step<\/h5>\n<p>This shows how netns-daemon-start works step by step.<\/p>\n<p>1. Get ready<\/p>\n<pre><span style=\"font-family: 'courier new', courier;\"><code> # cd opencontrail-netns-0.1\/opencontrail_netns\n # python\n Python 2.7.3 (default, Apr 10 2013, 06:20:15)\n [GCC 4.6.3] on linux2\n Type \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n &gt;&gt;&gt; from vnc_api import vnc_api\n &gt;&gt;&gt; import subprocess\n &gt;&gt;&gt; vnc = vnc_api.VncApi(username = 'admin', password = 'contrail123', tenant_name = 'admin', api_server_host = '10.84.18.2')<\/code><\/span><\/pre>\n<p>2. Configure Contrail<\/p>\n<pre><span style=\"font-family: 'courier new', courier;\"><code> &gt;&gt;&gt; vm_instance = vnc_api.VirtualMachine(name = 'a4s5-mysql')\n &gt;&gt;&gt; vnc.virtual_machine_create(vm_instance)\n u'3bf9a099-c25a-493f-ab83-a8ed21047e50'\n &gt;&gt;&gt;\n &gt;&gt;&gt; vm_interface = vnc_api.VirtualMachineInterface(name = 'veth0', parent_obj = vm_instance)\n &gt;&gt;&gt; vn = vnc.virtual_network_read(fq_name = ['default-domain', 'demo', 'database'])\n &gt;&gt;&gt; vm_interface.set_virtual_network(vn)\n &gt;&gt;&gt; vnc.virtual_machine_interface_create(vm_interface)\n u'a0590a72-2952-445f-a9bf-b5762d8cb9fe'\n &gt;&gt;&gt; vm_interface = vnc.virtual_machine_interface_read(id = vm_interface.uuid)\n &gt;&gt;&gt;\n &gt;&gt;&gt; ip = vnc_api.InstanceIp(name = 'a4s5-mysql.veth0')\n &gt;&gt;&gt; ip.set_virtual_machine_interface(vm_interface)\n &gt;&gt;&gt; ip.set_virtual_network(vn)\n &gt;&gt;&gt; vnc.instance_ip_create(ip)\n u'3dc7f645-6863-4b30-9a5a-14ce052e2ca3'\n &gt;&gt;&gt; ip = vnc.instance_ip_read(id = ip.uuid)\n &gt;&gt;&gt; ip.get_instance_ip_address()\n u'192.168.10.252'<\/code><\/span><\/pre>\n<p>3. Configure network namespace<\/p>\n<pre><span style=\"font-family: 'courier new', courier;\"><code> &gt;&gt;&gt; subprocess.call('ip netns add ns-mysql', shell = True)\n 0\n &gt;&gt;&gt; subprocess.call('ip netns list', shell = True)\n ns-mysql\n 0\n &gt;&gt;&gt; subprocess.call('ip link add veth0 type veth peer name instance0', shell = True)\n 0\n &gt;&gt;&gt; subprocess.call('ip link set veth0 netns ns-mysql', shell = True)\n 0\n &gt;&gt;&gt; subprocess.call('ip link set instance0 up', shell = True)\n 0\n &gt;&gt;&gt; mac = vm_interface.virtual_machine_interface_mac_addresses.mac_address[0]\n &gt;&gt;&gt; subprocess.call('ip netns exec ns-mysql ifconfig veth0 hw ether %s' %(mac), shell = True)\n 0<\/code><\/span><\/pre>\n<p>4. Register to vRouter<\/p>\n<pre><span style=\"font-family: 'courier new', courier;\"><code> &gt;&gt;&gt; import vrouter_control\n &gt;&gt;&gt; vrouter_control.add_interface('instance0', vm_interface.uuid, vm_instance.uuid, mac)<\/code><\/span><\/pre>\n<p>5. Configure interface<\/p>\n<pre><span style=\"font-family: 'courier new', courier;\"><code> &gt;&gt;&gt; subprocess.call('ip netns exec ns-mysql dhclient veth0', shell = True)\n 0\n &gt;&gt;&gt; subprocess.call('ip netns exec ns-mysql ip addr list', shell = True)\n 1: lo: mtu 65536 qdisc noop state DOWN\n link\/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n 11: veth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000\n link\/ether 02:a0:59:0a:72:29 brd ff:ff:ff:ff:ff:ff\n inet 192.168.10.252\/24 brd 192.168.10.255 scope global veth0\n inet6 fe80::a0:59ff:fe0a:7229\/64 scope link\n valid_lft forever preferred_lft forever<\/code><\/span><\/pre>\n<p>Now, in Contrail, virtual machine, virtual machine interface and routes are all set.<\/p>\n<p>&nbsp;<\/p>\n<p><img loading=\"lazy\" decoding=\"async\" class=\"alignnone size-full wp-image-5680\" src=\"http:\/\/www.opencontrail.org\/wp-content\/uploads\/2014\/10\/blogpost_july_23_2014_image3.png\" alt=\"blogpost_july_23_2014_image3\" width=\"1071\" height=\"234\" data-id=\"5680\" \/><img loading=\"lazy\" decoding=\"async\" class=\"alignnone size-full wp-image-5681\" src=\"http:\/\/www.opencontrail.org\/wp-content\/uploads\/2014\/10\/blogpost_july_23_2014_image4.png\" alt=\"blogpost_july_23_2014_image4\" width=\"1068\" height=\"640\" data-id=\"5681\" \/><\/p>\n<p>6. Start MySQL server in network namespace<\/p>\n<pre><span style=\"font-family: 'courier new', courier;\"><code># ip netns exec ns-mysql \/usr\/sbin\/mysqld<\/code><\/span><\/pre>\n<p>7. Connect MySQL server from VM \u201cclient\u201d<\/p>\n<pre><span style=\"font-family: 'courier new', courier;\"><code>[root@client ~]# ip addr list\n 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 16436 qdisc noqueue state UNKNOWN\n link\/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n inet 127.0.0.1\/8 scope host lo\n inet6 ::1\/128 scope host\n valid_lft forever preferred_lft forever\n 2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000\n link\/ether 02:b8:43:bb:24:41 brd ff:ff:ff:ff:ff:ff\n inet 192.168.1.253\/24 brd 192.168.1.255 scope global eth0\n inet6 fe80::b8:43ff:febb:2441\/64 scope link\n valid_lft forever preferred_lft forever\n [root@client ~]#\n [root@client ~]# mysql -h 192.168.10.252 -utony -ppassword\n Welcome to the MySQL monitor. Commands end with ; or \\g.\n Your MySQL connection id is 37\n Server version: 5.5.34-0ubuntu0.12.04.1 (Ubuntu)\n Copyright (c) 2000, 2013, Oracle and\/or its affiliates. All rights reserved.\n Oracle is a registered trademark of Oracle Corporation and\/or its\n affiliates. Other names may be trademarks of their respective\n owners.\n Type 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.\n mysql&gt;<\/code><\/span><\/pre>\n","protected":false},"excerpt":{"rendered":"<p>1 Network Namespace Network namespace is a feature of Linux kernel. A separate network stack can be created as a network namespace for an application to run on. Network namespace&#8230;<\/p>\n","protected":false},"author":477,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"footnotes":""},"categories":[9,1],"tags":[],"acf":[],"yoast_head":"<!-- This site is optimized with the Yoast SEO plugin v21.6 - https:\/\/yoast.com\/wordpress\/plugins\/seo\/ -->\n<title>Contrail and Network Namespace - Tungsten Fabric<\/title>\n<meta name=\"robots\" content=\"index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1\" \/>\n<link rel=\"canonical\" href=\"https:\/\/tungsten.io\/contrail-and-network-namespace\/\" \/>\n<meta property=\"og:locale\" content=\"en_US\" \/>\n<meta property=\"og:type\" content=\"article\" \/>\n<meta property=\"og:title\" content=\"Contrail and Network Namespace - Tungsten Fabric\" \/>\n<meta property=\"og:description\" content=\"1 Network Namespace Network namespace is a feature of Linux kernel. A separate network stack can be created as a network namespace for an application to run on. Network namespace...\" \/>\n<meta property=\"og:url\" content=\"https:\/\/tungsten.io\/contrail-and-network-namespace\/\" \/>\n<meta property=\"og:site_name\" content=\"Tungsten Fabric\" \/>\n<meta property=\"article:published_time\" content=\"2014-10-11T23:12:10+00:00\" \/>\n<meta property=\"og:image\" content=\"http:\/\/www.opencontrail.org\/wp-content\/uploads\/2014\/10\/blogpost_july_23_2014_image1.png\" \/>\n<meta name=\"author\" content=\"Tao Liu\" \/>\n<meta name=\"twitter:card\" content=\"summary_large_image\" \/>\n<script type=\"application\/ld+json\" class=\"yoast-schema-graph\">{\"@context\":\"https:\/\/schema.org\",\"@graph\":[{\"@type\":\"WebPage\",\"@id\":\"https:\/\/tungsten.io\/contrail-and-network-namespace\/\",\"url\":\"https:\/\/tungsten.io\/contrail-and-network-namespace\/\",\"name\":\"Contrail and Network Namespace - Tungsten Fabric\",\"isPartOf\":{\"@id\":\"https:\/\/tungsten.io\/#website\"},\"datePublished\":\"2014-10-11T23:12:10+00:00\",\"dateModified\":\"2014-10-11T23:12:10+00:00\",\"author\":{\"@id\":\"https:\/\/tungsten.io\/#\/schema\/person\/652c73ab3be18789410eddfb604abac4\"},\"inLanguage\":\"en-US\",\"potentialAction\":[{\"@type\":\"ReadAction\",\"target\":[\"https:\/\/tungsten.io\/contrail-and-network-namespace\/\"]}]},{\"@type\":\"WebSite\",\"@id\":\"https:\/\/tungsten.io\/#website\",\"url\":\"https:\/\/tungsten.io\/\",\"name\":\"Tungsten Fabric\",\"description\":\"multicloud multistack SDN\",\"potentialAction\":[{\"@type\":\"SearchAction\",\"target\":{\"@type\":\"EntryPoint\",\"urlTemplate\":\"https:\/\/tungsten.io\/?s={search_term_string}\"},\"query-input\":\"required name=search_term_string\"}],\"inLanguage\":\"en-US\"},{\"@type\":\"Person\",\"@id\":\"https:\/\/tungsten.io\/#\/schema\/person\/652c73ab3be18789410eddfb604abac4\",\"name\":\"Tao Liu\",\"image\":{\"@type\":\"ImageObject\",\"inLanguage\":\"en-US\",\"@id\":\"https:\/\/tungsten.io\/#\/schema\/person\/image\/\",\"url\":\"https:\/\/secure.gravatar.com\/avatar\/9f7dee7a2899790ac544fc0885ba289c?s=96&d=mm&r=pg\",\"contentUrl\":\"https:\/\/secure.gravatar.com\/avatar\/9f7dee7a2899790ac544fc0885ba289c?s=96&d=mm&r=pg\",\"caption\":\"Tao Liu\"},\"url\":\"https:\/\/tungsten.io\"}]}<\/script>\n<!-- \/ Yoast SEO plugin. -->","yoast_head_json":{"title":"Contrail and Network Namespace - Tungsten Fabric","robots":{"index":"index","follow":"follow","max-snippet":"max-snippet:-1","max-image-preview":"max-image-preview:large","max-video-preview":"max-video-preview:-1"},"canonical":"https:\/\/tungsten.io\/contrail-and-network-namespace\/","og_locale":"en_US","og_type":"article","og_title":"Contrail and Network Namespace - Tungsten Fabric","og_description":"1 Network Namespace Network namespace is a feature of Linux kernel. A separate network stack can be created as a network namespace for an application to run on. Network namespace...","og_url":"https:\/\/tungsten.io\/contrail-and-network-namespace\/","og_site_name":"Tungsten Fabric","article_published_time":"2014-10-11T23:12:10+00:00","og_image":[{"url":"http:\/\/www.opencontrail.org\/wp-content\/uploads\/2014\/10\/blogpost_july_23_2014_image1.png"}],"author":"Tao Liu","twitter_card":"summary_large_image","schema":{"@context":"https:\/\/schema.org","@graph":[{"@type":"WebPage","@id":"https:\/\/tungsten.io\/contrail-and-network-namespace\/","url":"https:\/\/tungsten.io\/contrail-and-network-namespace\/","name":"Contrail and Network Namespace - Tungsten Fabric","isPartOf":{"@id":"https:\/\/tungsten.io\/#website"},"datePublished":"2014-10-11T23:12:10+00:00","dateModified":"2014-10-11T23:12:10+00:00","author":{"@id":"https:\/\/tungsten.io\/#\/schema\/person\/652c73ab3be18789410eddfb604abac4"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https:\/\/tungsten.io\/contrail-and-network-namespace\/"]}]},{"@type":"WebSite","@id":"https:\/\/tungsten.io\/#website","url":"https:\/\/tungsten.io\/","name":"Tungsten Fabric","description":"multicloud multistack SDN","potentialAction":[{"@type":"SearchAction","target":{"@type":"EntryPoint","urlTemplate":"https:\/\/tungsten.io\/?s={search_term_string}"},"query-input":"required name=search_term_string"}],"inLanguage":"en-US"},{"@type":"Person","@id":"https:\/\/tungsten.io\/#\/schema\/person\/652c73ab3be18789410eddfb604abac4","name":"Tao Liu","image":{"@type":"ImageObject","inLanguage":"en-US","@id":"https:\/\/tungsten.io\/#\/schema\/person\/image\/","url":"https:\/\/secure.gravatar.com\/avatar\/9f7dee7a2899790ac544fc0885ba289c?s=96&d=mm&r=pg","contentUrl":"https:\/\/secure.gravatar.com\/avatar\/9f7dee7a2899790ac544fc0885ba289c?s=96&d=mm&r=pg","caption":"Tao Liu"},"url":"https:\/\/tungsten.io"}]}},"_links":{"self":[{"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/posts\/5161"}],"collection":[{"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/users\/477"}],"replies":[{"embeddable":true,"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/comments?post=5161"}],"version-history":[{"count":0,"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/posts\/5161\/revisions"}],"wp:attachment":[{"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/media?parent=5161"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/categories?post=5161"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/tags?post=5161"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}