{"id":1729,"date":"2014-09-20T04:37:12","date_gmt":"2014-09-20T04:37:12","guid":{"rendered":"http:\/\/opencontrail.org\/?p=1729"},"modified":"2014-09-20T04:37:12","modified_gmt":"2014-09-20T04:37:12","slug":"docker-with-opencontrail","status":"publish","type":"post","link":"https:\/\/tungsten.io\/docker-with-opencontrail\/","title":{"rendered":"Docker with OpenContrail"},"content":{"rendered":"<h5 style=\"color: #333333;\">1 Overview<\/h5>\n<p style=\"color: #333333;\">OpenContrail is the infrastructure of building and managing overlay virtual networks. It&#8217;s capable of connecting Docker contrainers across multiple service nodes into one or separate virtual networks, and connecting virtual networks based on defined policies.<\/p>\n<p><!--more Read more...--><\/p>\n<h6><img loading=\"lazy\" decoding=\"async\" class=\"alignnone wp-image-5684\" src=\"http:\/\/www.opencontrail.org\/wp-content\/uploads\/2014\/09\/opencontrail-docker-figure-1.png\" alt=\"opencontrail-docker-figure-1\" width=\"600\" height=\"337\" data-id=\"5684\" \/><\/h6>\n<h6>1.1 vRouter and virtual network<\/h6>\n<p>Vrouter is the forwarding engine of OpenContrail. It&#8217;s located in the host kernel. When a virtual network is created, a VRF is also created and associated to the virtual network. When vRouter receives packets, it determines which VRF packets will be sent to. Then vRouter looks up route in VRF, gets next-hop, and sends packets to it.<\/p>\n<h6><a class=\"anchor\" style=\"color: #4183c4;\" href=\"https:\/\/github.com\/tonyliu0592\/orch\/blob\/master\/doc\/opencontrail-docker.md#12-attach-container-to-virtual-network\" name=\"user-content-12-attach-container-to-virtual-network\"><\/a>1.2 Attach container to virtual network<\/h6>\n<p>To attach container to virtual network,<\/p>\n<ul class=\"task-list\">\n<li>create a tunnel with two veth interfaces (one end in kernel and another end in container),<\/li>\n<li>attach veth interface in kernel to the VRF of virtual network,<\/li>\n<li>allocate an IP address to this interface.<\/li>\n<\/ul>\n<p>DHCP server is provided by vRouter. After attach container to the virtual network, running DHCP client in the container will get the allocated IP address for the veth interface.<\/p>\n<p>A \/32 interface route of allocated IP address is also added into the VRF. The next-hop is the veth interface in kernel.<\/p>\n<h6><a class=\"anchor\" style=\"color: #4183c4;\" href=\"https:\/\/github.com\/tonyliu0592\/orch\/blob\/master\/doc\/opencontrail-docker.md#13-connect-containers-in-the-same-virtual-network\" name=\"user-content-13-connect-containers-in-the-same-virtual-network\"><\/a>1.3 Connect containers in the same virtual network<\/h6>\n<p>The interface route in each VRF will be advertised to all VRFs of the same virtual network in other servers. This is done by Contrail control component running BGP. Eventually, each VRF will have all routes of the same virtual network.<\/p>\n<h6><a class=\"anchor\" style=\"color: #4183c4;\" href=\"https:\/\/github.com\/tonyliu0592\/orch\/blob\/master\/doc\/opencontrail-docker.md#14-connect-virtual-networks-by-network-policy\" name=\"user-content-14-connect-virtual-networks-by-network-policy\"><\/a>1.4 Connect virtual networks by network policy<\/h6>\n<p>By default, virtual networks are isolated. Routes of containers in one virtual network are not advertised to any other virtual network. To connect virtual networks, network policy has to be defined and attached to virtual networks.<\/p>\n<p>Protocol, port and virtual network can be configured in the network policy to specify what traffic is allowed between which virtual networks.<\/p>\n<h6><a class=\"anchor\" style=\"color: #4183c4;\" href=\"https:\/\/github.com\/tonyliu0592\/orch\/blob\/master\/doc\/opencontrail-docker.md#15-flow-statistics\" name=\"user-content-15-flow-statistics\"><\/a>1.5 Flow statistics<\/h6>\n<p>OpenContrail is capable of collecting flow statistics and providing REST API interface for users to query. This makes it possible for users to create a feedback loop. By monitoring the traffic, users can check policy enforcement, change container deployment based on traffic load, etc.<\/p>\n<h6><a class=\"anchor\" style=\"color: #4183c4;\" href=\"https:\/\/github.com\/tonyliu0592\/orch\/blob\/master\/doc\/opencontrail-docker.md#16-externalpublic-access\" name=\"user-content-16-externalpublic-access\"><\/a>1.6 External\/Public access<\/h6>\n<p>Floating IP is supported by OpenContrail to enable external\/public access for containers. Gateway is required to support this feature.<\/p>\n<h5><a class=\"anchor\" style=\"color: #4183c4;\" href=\"https:\/\/github.com\/tonyliu0592\/orch\/blob\/master\/doc\/opencontrail-docker.md#2-example\" name=\"user-content-2-example\"><\/a>2 Example<\/h5>\n<p>This example is based on OpenContrail 1.06 and Ubuntu 12.04.3.<\/p>\n<h6><a class=\"anchor\" style=\"color: #4183c4;\" href=\"https:\/\/github.com\/tonyliu0592\/orch\/blob\/master\/doc\/opencontrail-docker.md#21-installation\" name=\"user-content-21-installation\"><\/a>2.1 Installation<\/h6>\n<h6><a class=\"anchor\" style=\"color: #4183c4;\" href=\"https:\/\/github.com\/tonyliu0592\/orch\/blob\/master\/doc\/opencontrail-docker.md#211-opencontrail\" name=\"user-content-211-opencontrail\"><\/a>2.1.1 OpenContrail<\/h6>\n<p><a href=\"https:\/\/github.com\/Juniper\/contrail-controller\/wiki\/Install-and-Configure-OpenContrail-1.06\">OpenContrail Installation<\/a><\/p>\n<h6><a class=\"anchor\" style=\"color: #4183c4;\" href=\"https:\/\/github.com\/tonyliu0592\/orch\/blob\/master\/doc\/opencontrail-docker.md#212-docker\" name=\"user-content-212-docker\"><\/a>2.1.2 Docker<\/h6>\n<pre><span style=\"font-family: 'courier new', courier;\"><code> $ sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 36A1D7869245C8950F966E92D8576A8BA88D21E9\n $ echo \"deb https:\/\/get.docker.io\/ubuntu docker main\" | sudo tee -a \/etc\/apt\/sources.list.d\/docker.list\n $ sudo apt-get update\n $ sudo apt-get install lxc-docker<\/code><\/span><\/pre>\n<p><span style=\"color: #333333;\">Download Ubuntu image and check if it works.<\/span><\/p>\n<pre><span style=\"font-family: 'courier new', courier;\"><code>$ sudo docker run -i -t ubuntu \/bin\/bash<\/code><\/span><\/pre>\n<h6 style=\"color: #333333;\">2.1.3 Utility of opencontrail-netns<\/h6>\n<pre><span style=\"font-family: 'courier new', courier;\"><code>$ git clone https:\/\/github.com\/pedro-r-marques\/opencontrail-netns.git<\/code><\/span><\/pre>\n<p><span style=\"color: #333333;\">This utility does all configurations to connect vRouter and container.<\/span><\/p>\n<h6 style=\"color: #333333;\">2.1.4 Utlity of config<\/h6>\n<pre><span style=\"font-family: 'courier new', courier;\"><code>$ git clone https:\/\/github.com\/tonyliu0592\/orch.git<\/code><\/span><\/pre>\n<p style=\"color: #333333;\">This utility does OpenContrail configurations. Update\u00a0<em>config\u00a0<\/em>with correct settings.<\/p>\n<h6 style=\"color: #333333;\"><a class=\"anchor\" style=\"color: #4183c4;\" href=\"https:\/\/github.com\/tonyliu0592\/orch\/blob\/master\/doc\/opencontrail-docker.md#22-connect-container-to-virtual-network\" name=\"user-content-22-connect-container-to-virtual-network\"><\/a>2.2 Connect container to virtual network<\/h6>\n<h6 style=\"color: #333333;\"><a class=\"anchor\" style=\"color: #4183c4;\" href=\"https:\/\/github.com\/tonyliu0592\/orch\/blob\/master\/doc\/opencontrail-docker.md#create-virtual-networks\" name=\"user-content-create-virtual-networks\"><\/a>Create virtual networks<\/h6>\n<p style=\"color: #333333;\">Create two virtual networks, &#8220;red&#8221; and &#8220;green&#8221;, in tenant &#8220;admin&#8221;. Assume tenant &#8220;admin&#8221; is already created.<\/p>\n<pre><span style=\"font-family: 'courier new', courier;\"><code> $ cd orch\n $ .\/config add ipam ipam-default\n $ .\/config add network red --ipam ipam-default --subnet 192.168.10.0\/24\n $ .\/config add network green --ipam ipam-default --subnet 192.168.20.0\/24<\/code><\/span><\/pre>\n<h6 style=\"color: #333333;\">Create containers<\/h6>\n<p style=\"color: #333333;\">Create two containers. Type CTRL-p and CTRL-q to exit container and keep it running.<\/p>\n<pre><span style=\"font-family: 'courier new', courier;\"><code> $ sudo docker run -i -t --net=\"none\" ubuntu \/bin\/bash\n $ sudo docker run -i -t --net=\"none\" ubuntu \/bin\/bash<\/code><\/span><\/pre>\n<h6 style=\"color: #333333;\">Connect container to virtual network<\/h6>\n<p style=\"color: #333333;\">Find out the container ID.<\/p>\n<pre><span style=\"font-family: 'courier new', courier;\"><code> $ sudo docker ps\n CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES\n dccf1ec5a438 ubuntu:latest \"bash\" 38 minutes ago Up 38 minutes naughty_mcclintock\n 0996f6040d5d ubuntu:latest \"bash\" 38 minutes ago Up 38 minutes sleepy_brown <\/code><\/span><\/pre>\n<p><span style=\"color: #333333;\">Connect one container to each virtual network respectively.<\/span><\/p>\n<pre><span style=\"font-family: 'courier new', courier;\"><code> $ sudo mkdir -p \/var\/run\/netns\n $ cd ..\/opencontrail-netns\/opencontrail_netns\n $ python docker.py -s  -n red --project default-domain:admin --start dccf1ec5a438\n $ python docker.py -s  -n green --project default-domain:admin --start 0996f6040d5d<\/code><\/span><\/pre>\n<p style=\"color: #333333;\">Now, two containers are connected to two virtual networks respectively. Policy needs to be created and attached to two virtual networks to allow traffic flow between each other.<\/p>\n<h6 style=\"color: #333333;\"><a class=\"anchor\" style=\"color: #4183c4;\" href=\"https:\/\/github.com\/tonyliu0592\/orch\/blob\/master\/doc\/opencontrail-docker.md#connect-virtual-networks-by-network-policy\" name=\"user-content-connect-virtual-networks-by-network-policy\"><\/a>Connect virtual networks by network policy<\/h6>\n<p style=\"color: #333333;\">Create a policy to pass all traffic and attach to two virtual networks.<\/p>\n<pre><span style=\"font-family: 'courier new', courier;\"><code> $ cd ..\/..\/orch\n $ .\/config add policy policy-default\n $ .\/config add network red --policy policy-default\n $ .\/config add network green --policy policy-default<\/code><\/span><\/pre>\n<p><span style=\"color: #333333;\">Login container and test connection.<\/span><\/p>\n<pre><code><span style=\"font-family: 'courier new', courier;\"> $ sudo docker attach dccf1ec5a438<\/span>\n<span style=\"font-family: 'courier new', courier;\"> root@dccf1ec5a438:\/# ip addr show veth0<\/span>\n<span style=\"font-family: 'courier new', courier;\"> 34: veth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<\/span>\n<span style=\"font-family: 'courier new', courier;\"> link\/ether 02:1a:74:99:fe:5f brd ff:ff:ff:ff:ff:ff<\/span>\n<span style=\"font-family: 'courier new', courier;\"> inet 192.168.10.253\/24 brd 192.168.10.255 scope global veth0<\/span>\n<span style=\"font-family: 'courier new', courier;\"> inet6 fe80::1a:74ff:fe99:fe5f\/64 scope link<\/span>\n<span style=\"font-family: 'courier new', courier;\"> valid_lft forever preferred_lft forever<\/span>\n<span style=\"font-family: 'courier new', courier;\"> root@dccf1ec5a438:\/# ping 192.168.20.253<\/span>\n<span style=\"font-family: 'courier new', courier;\"> PING 192.168.20.253 (192.168.20.253) 56(84) bytes of data.<\/span>\n<span style=\"font-family: 'courier new', courier;\"> 64 bytes from 192.168.20.253: icmp_seq=1 ttl=64 time=0.774 ms<\/span>\n<span style=\"font-family: 'courier new', courier;\"> 64 bytes from 192.168.20.253: icmp_seq=2 ttl=64 time=0.066 ms<\/span>\n <\/code><\/pre>\n","protected":false},"excerpt":{"rendered":"<p>1 Overview OpenContrail is the infrastructure of building and managing overlay virtual networks. It&#8217;s capable of connecting Docker contrainers across multiple service nodes into one or separate virtual networks, and&#8230;<\/p>\n","protected":false},"author":477,"featured_media":0,"comment_status":"open","ping_status":"closed","sticky":false,"template":"","format":"standard","meta":{"footnotes":""},"categories":[11,1],"tags":[],"acf":[],"yoast_head":"<!-- This site is optimized with the Yoast SEO plugin v21.6 - https:\/\/yoast.com\/wordpress\/plugins\/seo\/ -->\n<title>Docker with OpenContrail - Tungsten Fabric<\/title>\n<meta name=\"robots\" content=\"index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1\" \/>\n<link rel=\"canonical\" href=\"https:\/\/tungsten.io\/docker-with-opencontrail\/\" \/>\n<meta property=\"og:locale\" content=\"en_US\" \/>\n<meta property=\"og:type\" content=\"article\" \/>\n<meta property=\"og:title\" content=\"Docker with OpenContrail - Tungsten Fabric\" \/>\n<meta property=\"og:description\" content=\"1 Overview OpenContrail is the infrastructure of building and managing overlay virtual networks. It&#8217;s capable of connecting Docker contrainers across multiple service nodes into one or separate virtual networks, and...\" \/>\n<meta property=\"og:url\" content=\"https:\/\/tungsten.io\/docker-with-opencontrail\/\" \/>\n<meta property=\"og:site_name\" content=\"Tungsten Fabric\" \/>\n<meta property=\"article:published_time\" content=\"2014-09-20T04:37:12+00:00\" \/>\n<meta property=\"og:image\" content=\"http:\/\/www.opencontrail.org\/wp-content\/uploads\/2014\/09\/opencontrail-docker-figure-1.png\" \/>\n<meta name=\"author\" content=\"Tao Liu\" \/>\n<meta name=\"twitter:card\" content=\"summary_large_image\" \/>\n<script type=\"application\/ld+json\" class=\"yoast-schema-graph\">{\"@context\":\"https:\/\/schema.org\",\"@graph\":[{\"@type\":\"WebPage\",\"@id\":\"https:\/\/tungsten.io\/docker-with-opencontrail\/\",\"url\":\"https:\/\/tungsten.io\/docker-with-opencontrail\/\",\"name\":\"Docker with OpenContrail - Tungsten Fabric\",\"isPartOf\":{\"@id\":\"https:\/\/tungsten.io\/#website\"},\"datePublished\":\"2014-09-20T04:37:12+00:00\",\"dateModified\":\"2014-09-20T04:37:12+00:00\",\"author\":{\"@id\":\"https:\/\/tungsten.io\/#\/schema\/person\/652c73ab3be18789410eddfb604abac4\"},\"inLanguage\":\"en-US\",\"potentialAction\":[{\"@type\":\"ReadAction\",\"target\":[\"https:\/\/tungsten.io\/docker-with-opencontrail\/\"]}]},{\"@type\":\"WebSite\",\"@id\":\"https:\/\/tungsten.io\/#website\",\"url\":\"https:\/\/tungsten.io\/\",\"name\":\"Tungsten Fabric\",\"description\":\"multicloud multistack SDN\",\"potentialAction\":[{\"@type\":\"SearchAction\",\"target\":{\"@type\":\"EntryPoint\",\"urlTemplate\":\"https:\/\/tungsten.io\/?s={search_term_string}\"},\"query-input\":\"required name=search_term_string\"}],\"inLanguage\":\"en-US\"},{\"@type\":\"Person\",\"@id\":\"https:\/\/tungsten.io\/#\/schema\/person\/652c73ab3be18789410eddfb604abac4\",\"name\":\"Tao Liu\",\"image\":{\"@type\":\"ImageObject\",\"inLanguage\":\"en-US\",\"@id\":\"https:\/\/tungsten.io\/#\/schema\/person\/image\/\",\"url\":\"https:\/\/secure.gravatar.com\/avatar\/9f7dee7a2899790ac544fc0885ba289c?s=96&d=mm&r=pg\",\"contentUrl\":\"https:\/\/secure.gravatar.com\/avatar\/9f7dee7a2899790ac544fc0885ba289c?s=96&d=mm&r=pg\",\"caption\":\"Tao Liu\"},\"url\":\"https:\/\/tungsten.io\"}]}<\/script>\n<!-- \/ Yoast SEO plugin. -->","yoast_head_json":{"title":"Docker with OpenContrail - Tungsten Fabric","robots":{"index":"index","follow":"follow","max-snippet":"max-snippet:-1","max-image-preview":"max-image-preview:large","max-video-preview":"max-video-preview:-1"},"canonical":"https:\/\/tungsten.io\/docker-with-opencontrail\/","og_locale":"en_US","og_type":"article","og_title":"Docker with OpenContrail - Tungsten Fabric","og_description":"1 Overview OpenContrail is the infrastructure of building and managing overlay virtual networks. It&#8217;s capable of connecting Docker contrainers across multiple service nodes into one or separate virtual networks, and...","og_url":"https:\/\/tungsten.io\/docker-with-opencontrail\/","og_site_name":"Tungsten Fabric","article_published_time":"2014-09-20T04:37:12+00:00","og_image":[{"url":"http:\/\/www.opencontrail.org\/wp-content\/uploads\/2014\/09\/opencontrail-docker-figure-1.png"}],"author":"Tao Liu","twitter_card":"summary_large_image","schema":{"@context":"https:\/\/schema.org","@graph":[{"@type":"WebPage","@id":"https:\/\/tungsten.io\/docker-with-opencontrail\/","url":"https:\/\/tungsten.io\/docker-with-opencontrail\/","name":"Docker with OpenContrail - Tungsten Fabric","isPartOf":{"@id":"https:\/\/tungsten.io\/#website"},"datePublished":"2014-09-20T04:37:12+00:00","dateModified":"2014-09-20T04:37:12+00:00","author":{"@id":"https:\/\/tungsten.io\/#\/schema\/person\/652c73ab3be18789410eddfb604abac4"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https:\/\/tungsten.io\/docker-with-opencontrail\/"]}]},{"@type":"WebSite","@id":"https:\/\/tungsten.io\/#website","url":"https:\/\/tungsten.io\/","name":"Tungsten Fabric","description":"multicloud multistack SDN","potentialAction":[{"@type":"SearchAction","target":{"@type":"EntryPoint","urlTemplate":"https:\/\/tungsten.io\/?s={search_term_string}"},"query-input":"required name=search_term_string"}],"inLanguage":"en-US"},{"@type":"Person","@id":"https:\/\/tungsten.io\/#\/schema\/person\/652c73ab3be18789410eddfb604abac4","name":"Tao Liu","image":{"@type":"ImageObject","inLanguage":"en-US","@id":"https:\/\/tungsten.io\/#\/schema\/person\/image\/","url":"https:\/\/secure.gravatar.com\/avatar\/9f7dee7a2899790ac544fc0885ba289c?s=96&d=mm&r=pg","contentUrl":"https:\/\/secure.gravatar.com\/avatar\/9f7dee7a2899790ac544fc0885ba289c?s=96&d=mm&r=pg","caption":"Tao Liu"},"url":"https:\/\/tungsten.io"}]}},"_links":{"self":[{"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/posts\/1729"}],"collection":[{"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/users\/477"}],"replies":[{"embeddable":true,"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/comments?post=1729"}],"version-history":[{"count":0,"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/posts\/1729\/revisions"}],"wp:attachment":[{"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/media?parent=1729"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/categories?post=1729"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/tags?post=1729"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}