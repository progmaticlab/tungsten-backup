{"id":7114,"date":"2016-07-11T15:17:57","date_gmt":"2016-07-11T22:17:57","guid":{"rendered":"http:\/\/www.opencontrail.org\/?p=7114"},"modified":"2016-07-11T15:17:57","modified_gmt":"2016-07-11T22:17:57","slug":"migrating-a-legacy-cloud-infrastructure-to-contrail-sdn-based-infrastructure","status":"publish","type":"post","link":"https:\/\/tungsten.io\/migrating-a-legacy-cloud-infrastructure-to-contrail-sdn-based-infrastructure\/","title":{"rendered":"Migrating a legacy cloud infrastructure to Contrail SDN based infrastructure"},"content":{"rendered":"<p>This app-note describes a mechanism to migrate a legacy cloud-based infrastructure which could use a L2 based network segmentation using technologies such as Linux Bridge or OVS to a Contrail SDN based cloud infrastructure. Both Legacy and Contrail clusters can co-exist side by side such that a single L3 subnet can span across both legacy and contrail clusters. This facilitates the cloud administrators to perform a phase wise migration of virtual workloads from legacy to contrail cluster. In addition to this both Legacy and Contrail workloads also have a public internet access.<\/p>\n<p><a href=\"http:\/\/www.opencontrail.org\/wp-content\/uploads\/2016\/07\/migration-to-EVPN_blogpost_image1.png\"><img loading=\"lazy\" decoding=\"async\" class=\"wp-image-7115 aligncenter\" src=\"http:\/\/www.opencontrail.org\/wp-content\/uploads\/2016\/07\/migration-to-EVPN_blogpost_image1.png\" alt=\"migration to EVPN_blogpost_image1\" width=\"650\" height=\"349\" data-id=\"7115\" \/><\/a><\/p>\n<h3>Proposed solutions:<\/h3>\n<p>Idea is to use separate logical L2 &amp; L3 SDN gateways to interconnect the Legacy cloud and the Contrail cloud and provide public internet access from both the clouds. L2 gateway PE will be peered to Contrail Controller for EVPN address family and will hence exchange the MAC address routes of the VMs. Also the the PE-CE link of the EVPN routing-instance is connected to the legacy cloud L2 fabric. This will make the Contrail Virtual Network to be stretched to the legacy cloud. 2 EVPN PE\u2019s are installed for redundancy and the PE Ethernet interface on both the PE\u2019s are configured as single homed Ethernet segment (ESI 0).  Spanning tree will be used to break the Layer 2 loop formed by the L2 Network and the redundant EVPN PE\u2019s. In this case, only one L3-SDN GW is shown. Adding the second L3-GW for the redundancy doesn\u2019t add much complexity and is just a matter of configuring BGP between Contrail and the second L3-GW.<\/p>\n<p><strong>Note: The L2 &amp; L3 gateway functionalities can be easily collapsed 2 physical MX routers. This can be done either by using 2 separate routing instances for EVPN and L3VPN and separate PE-CE link towards Legacy cloud (EVPN L2 ifl) and the public network (L3VPN L3 ifl). In this example, separate routers are used for ease of illustration.<\/strong><\/p>\n<p>The public access from the legacy cloud VM is through the L3-GW configured on the IRB (VLAN) interface aggregation switch (192.168.1.250 in this example) whereas for the VMs running on the Contrail cloud the traffic from the VM towards the public internet is through the default route originated from MX L3GW VRF. This default route actually will redirect the traffic to inet.0 on the MX L3-GW for internet access.<\/p>\n<p>&nbsp;<\/p>\n<p>Return traffic from the internet always will be routed to the legacy and the contrail cloud via the legacy L3 GW configured on the aggregation switch. The interface between qfx5100-sw1 and mx-l3gw is configured as a L3 interface and provides the return path from the public network to the legacy cloud and the contrail cloud.<\/p>\n<h3><strong>Example setup: Verification:<\/strong><\/h3>\n<p><strong>Contrail Virtual Network configuration and vrouter routing table entries<\/strong><\/p>\n<p><a href=\"http:\/\/www.opencontrail.org\/wp-content\/uploads\/2016\/07\/migration-to-EVPN_blogpost_image2.png\"><img loading=\"lazy\" decoding=\"async\" class=\"aligncenter wp-image-7116\" src=\"http:\/\/www.opencontrail.org\/wp-content\/uploads\/2016\/07\/migration-to-EVPN_blogpost_image2.png\" alt=\"migration to EVPN_blogpost_image2\" width=\"800\" height=\"437\" data-id=\"7116\" \/><\/a><\/p>\n<p><a href=\"http:\/\/www.opencontrail.org\/wp-content\/uploads\/2016\/07\/migration-to-EVPN_blogpost_image3.png\"><img loading=\"lazy\" decoding=\"async\" class=\"aligncenter wp-image-7117\" src=\"http:\/\/www.opencontrail.org\/wp-content\/uploads\/2016\/07\/migration-to-EVPN_blogpost_image3.png\" alt=\"migration to EVPN_blogpost_image3\" width=\"800\" height=\"358\" data-id=\"7117\" \/><\/a><\/p>\n<p><a href=\"http:\/\/www.opencontrail.org\/wp-content\/uploads\/2016\/07\/migration-to-EVPN_blogpost_image4.png\"><img loading=\"lazy\" decoding=\"async\" class=\"aligncenter wp-image-7118\" src=\"http:\/\/www.opencontrail.org\/wp-content\/uploads\/2016\/07\/migration-to-EVPN_blogpost_image4.png\" alt=\"migration to EVPN_blogpost_image4\" width=\"801\" height=\"309\" data-id=\"7118\" \/><\/a><\/p>\n<p>&nbsp;<\/p>\n<p><strong>Verify traffic flow from Legacy VM to Contrail VM and Internet:<\/strong><\/p>\n<pre><span style=\"font-family: 'courier new', courier;\">\nroot@legacy-vm:~# ip route\n<mark>default via 192.168.1.250 dev p514p1 <\/mark>\n10.84.0.0\/16 via 10.87.65.126 dev p514p2\n10.87.0.0\/16 via 10.87.65.126 dev p514p2\n10.87.65.0\/25 dev p514p2  proto kernel  scope link  src 10.87.65.2\n<mark>192.168.1.0\/24 dev p514p1  proto kernel  scope link  src 192.168.1.111<\/mark>\nroot@legacy-vm:~#\nroot@legacy-vm:~# ping 8.8.8.8 -c 2\nPING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.\n64 bytes from 8.8.8.8: icmp_seq=1 ttl=63 time=0.398 ms\n64 bytes from 8.8.8.8: icmp_seq=2 ttl=63 time=0.412 ms\n \n\n--- 8.8.8.8 ping statistics ---\n2 packets transmitted, 2 received, 0% packet loss, time 999ms\nrtt min\/avg\/max\/mdev = 0.398\/0.405\/0.412\/0.007 ms\nroot@legacy-vm:~# ping 192.168.1.4 -c 2\nPING 192.168.1.4 (192.168.1.4) 56(84) bytes of data.\n64 bytes from 192.168.1.4: icmp_seq=1 ttl=62 time=1.34 ms\n64 bytes from 192.168.1.4: icmp_seq=2 ttl=62 time=0.384 ms\n \n\n--- 192.168.1.4 ping statistics ---\n2 packets transmitted, 2 received, 0% packet loss, time 1001ms\nrtt min\/avg\/max\/mdev = 0.384\/0.863\/1.342\/0.479 ms\nroot@legacy-vm:~# arp\nAddress                  HWtype  HWaddress           Flags Mask            Iface\n<mark>192.168.1.4              ether   02:9a:66:37:06:5c   C                     p514p1<\/mark>\n<mark>192.168.1.250            ether   54:4b:8c:a8:8c:00   C                     p514p1<\/mark>\n10.87.65.126             ether   30:7c:5e:0f:8f:c0   C                     p514p2\nroot@legacy-vm:~#<\/span><\/pre>\n<p><strong>On the MX L2 &amp; L3 gateways:<\/strong><\/p>\n<p><strong>mx-l2-gw1 (connected to qfx5100-sw1 whose interface is in spanning blocked state)<\/strong><\/p>\n<pre><span style=\"font-family: 'courier new', courier;\">\nroot@mx-l2-gw1# run show bridge mac-table\n\n \n\nMAC flags       (S -static MAC, D -dynamic MAC, L -locally learned, C -Control MAC\nO -OVSDB MAC, SE -Statistics enabled, NM -Non configured MAC, R -Remote PE MAC)\n\n \n\nRouting instance : contrail_l2_4_VN-1\nBridging domain : bd-4, VLAN : none\nMAC                 MAC      Logical                Active\naddress             flags    interface              source\n02:9a:66:37:06:5c   D        vtep.32769             10.87.65.1\n54:4b:8c:a0:cc:82   D        vtep.32770             172.16.101.3\n90:e2:ba:aa:81:20   D        vtep.32770             172.16.101.3\n \n\n[edit]\n\nroot@mx-l2-gw1#<\/span><\/pre>\n<p><strong>mx-l2-gw1 (connected to qfx5100-sw2 whose interface is in spanning forwarding state)<\/strong><\/p>\n<pre><span style=\"font-family: 'courier new', courier;\">\nroot@mx-l2-gw2# run show bridge mac-table\n\n \n\nMAC flags       (S -static MAC, D -dynamic MAC, L -locally learned, C -Control MAC\nO -OVSDB MAC, SE -Statistics enabled, NM -Non configured MAC, R -Remote PE MAC)\n\n \n\nRouting instance : contrail_l2_4_VN-1\nBridging domain : bd-4, VLAN : none\nMAC                 MAC      Logical                Active\naddress             flags    interface              source\n02:9a:66:37:06:5c   D        vtep.32769             10.87.65.1\n54:4b:8c:a0:cc:82   D        xe-0\/0\/1.0\n90:e2:ba:aa:81:20   D        xe-0\/0\/1.0\n\n[edit]\n\nroot@mx-l2-gw2#<\/span><\/pre>\n<p><strong>mx-l3-gw<\/strong><\/p>\n<pre><span style=\"font-family: 'courier new', courier;\">\nroot@mx-l3-gw# run show route table contrail-l3_4_VN-1.inet.0\n\n \n\ncontrail-l3_4_VN-1.inet.0: 3 destinations, 3 routes (3 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n \n0.0.0.0\/0          *[Static\/5] 02:48:06\nto table inet.0\n192.168.1.0\/24     *[Static\/5] 1d 08:30:30\nDiscard\n192.168.1.4\/32     *[BGP\/170] 03:03:33, MED 100, localpref 200, from 10.87.65.1\nAS path: ?, validation-state: unverified\n&gt; via gr-0\/0\/0.32769, Push 16\n\n[edit]\n\nroot@mx-l3-gw# run show route table inet.0 192.168.1.0\/24\ninet.0: 10 destinations, 11 routes (10 active, 0 holddown, 0 hidden)\n+ = Active Route, - = Last Active, * = Both\n\n \n192.168.1.0\/24     *[Static\/5] 07:59:03\n&gt; to 192.168.50.1 via xe-0\/0\/1.0\n \n\n[edit]\n\nroot@mx-l3-gw#<\/span><\/pre>\n<p><strong>qfx5100-sw1<\/strong><\/p>\n<pre><span style=\"font-family: 'courier new', courier;\">\nroot@qfx5100-sw1# run show spanning-tree interface\n\n \n\nSpanning tree interface parameters for instance 0\n \nInterface                  Port ID    Designated         Designated         Port    State  Role\nport ID           bridge ID          Cost\nxe-0\/0\/42                 128:1095     128:1097  16384.544b8ca0cc82         2000    BLK    ALT\nxe-0\/0\/45                 128:1101     128:1101   8192.544b8ca88c02         2000    FWD    ROOT\n \n\n{master:0}[edit]\n\nroot@qfx5100-sw1#<\/span><\/pre>\n<p><strong>qfx5100-sw2<\/strong><\/p>\n<pre><span style=\"font-family: 'courier new', courier;\">\nroot@qfx5100-sw2# run show spanning-tree interface\n\n \nSpanning tree interface parameters for instance 0\n \nInterface                  Port ID    Designated         Designated         Port    State  Role\nport ID           bridge ID          Cost\nxe-0\/0\/43                 128:1097     128:1097  16384.544b8ca0cc82         2000    FWD    DESG\nxe-0\/0\/44                 128:1099     128:1099   8192.544b8ca88c02         2000    FWD    ROOT\n \n\n{master:0}[edit]\n\nroot@qfx5100-sw2#<\/span><\/pre>\n","protected":false},"excerpt":{"rendered":"<p>This app-note describes a mechanism to migrate a legacy cloud-based infrastructure which could use a L2 based network segmentation using technologies such as Linux Bridge or OVS to a Contrail&#8230;<\/p>\n","protected":false},"author":487,"featured_media":0,"comment_status":"open","ping_status":"closed","sticky":false,"template":"","format":"standard","meta":{"footnotes":""},"categories":[6,29,7,8,28],"tags":[],"acf":[],"yoast_head":"<!-- This site is optimized with the Yoast SEO plugin v21.6 - https:\/\/yoast.com\/wordpress\/plugins\/seo\/ -->\n<title>Migrating a legacy cloud infrastructure to Contrail SDN based infrastructure - Tungsten Fabric<\/title>\n<meta name=\"robots\" content=\"index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1\" \/>\n<link rel=\"canonical\" href=\"https:\/\/tungsten.io\/migrating-a-legacy-cloud-infrastructure-to-contrail-sdn-based-infrastructure\/\" \/>\n<meta property=\"og:locale\" content=\"en_US\" \/>\n<meta property=\"og:type\" content=\"article\" \/>\n<meta property=\"og:title\" content=\"Migrating a legacy cloud infrastructure to Contrail SDN based infrastructure - Tungsten Fabric\" \/>\n<meta property=\"og:description\" content=\"This app-note describes a mechanism to migrate a legacy cloud-based infrastructure which could use a L2 based network segmentation using technologies such as Linux Bridge or OVS to a Contrail...\" \/>\n<meta property=\"og:url\" content=\"https:\/\/tungsten.io\/migrating-a-legacy-cloud-infrastructure-to-contrail-sdn-based-infrastructure\/\" \/>\n<meta property=\"og:site_name\" content=\"Tungsten Fabric\" \/>\n<meta property=\"article:published_time\" content=\"2016-07-11T22:17:57+00:00\" \/>\n<meta property=\"og:image\" content=\"http:\/\/www.opencontrail.org\/wp-content\/uploads\/2016\/07\/migration-to-EVPN_blogpost_image1.png\" \/>\n<meta name=\"author\" content=\"Vivekananda Shenoy\" \/>\n<meta name=\"twitter:card\" content=\"summary_large_image\" \/>\n<script type=\"application\/ld+json\" class=\"yoast-schema-graph\">{\"@context\":\"https:\/\/schema.org\",\"@graph\":[{\"@type\":\"WebPage\",\"@id\":\"https:\/\/tungsten.io\/migrating-a-legacy-cloud-infrastructure-to-contrail-sdn-based-infrastructure\/\",\"url\":\"https:\/\/tungsten.io\/migrating-a-legacy-cloud-infrastructure-to-contrail-sdn-based-infrastructure\/\",\"name\":\"Migrating a legacy cloud infrastructure to Contrail SDN based infrastructure - Tungsten Fabric\",\"isPartOf\":{\"@id\":\"https:\/\/tungsten.io\/#website\"},\"datePublished\":\"2016-07-11T22:17:57+00:00\",\"dateModified\":\"2016-07-11T22:17:57+00:00\",\"author\":{\"@id\":\"https:\/\/tungsten.io\/#\/schema\/person\/f9fb75fb71925ab248ee074c098c3b1b\"},\"inLanguage\":\"en-US\",\"potentialAction\":[{\"@type\":\"ReadAction\",\"target\":[\"https:\/\/tungsten.io\/migrating-a-legacy-cloud-infrastructure-to-contrail-sdn-based-infrastructure\/\"]}]},{\"@type\":\"WebSite\",\"@id\":\"https:\/\/tungsten.io\/#website\",\"url\":\"https:\/\/tungsten.io\/\",\"name\":\"Tungsten Fabric\",\"description\":\"multicloud multistack SDN\",\"potentialAction\":[{\"@type\":\"SearchAction\",\"target\":{\"@type\":\"EntryPoint\",\"urlTemplate\":\"https:\/\/tungsten.io\/?s={search_term_string}\"},\"query-input\":\"required name=search_term_string\"}],\"inLanguage\":\"en-US\"},{\"@type\":\"Person\",\"@id\":\"https:\/\/tungsten.io\/#\/schema\/person\/f9fb75fb71925ab248ee074c098c3b1b\",\"name\":\"Vivekananda Shenoy\",\"image\":{\"@type\":\"ImageObject\",\"inLanguage\":\"en-US\",\"@id\":\"https:\/\/tungsten.io\/#\/schema\/person\/image\/\",\"url\":\"https:\/\/secure.gravatar.com\/avatar\/7bf737562887a3a650fb532b763430a2?s=96&d=mm&r=pg\",\"contentUrl\":\"https:\/\/secure.gravatar.com\/avatar\/7bf737562887a3a650fb532b763430a2?s=96&d=mm&r=pg\",\"caption\":\"Vivekananda Shenoy\"},\"url\":\"https:\/\/tungsten.io\"}]}<\/script>\n<!-- \/ Yoast SEO plugin. -->","yoast_head_json":{"title":"Migrating a legacy cloud infrastructure to Contrail SDN based infrastructure - Tungsten Fabric","robots":{"index":"index","follow":"follow","max-snippet":"max-snippet:-1","max-image-preview":"max-image-preview:large","max-video-preview":"max-video-preview:-1"},"canonical":"https:\/\/tungsten.io\/migrating-a-legacy-cloud-infrastructure-to-contrail-sdn-based-infrastructure\/","og_locale":"en_US","og_type":"article","og_title":"Migrating a legacy cloud infrastructure to Contrail SDN based infrastructure - Tungsten Fabric","og_description":"This app-note describes a mechanism to migrate a legacy cloud-based infrastructure which could use a L2 based network segmentation using technologies such as Linux Bridge or OVS to a Contrail...","og_url":"https:\/\/tungsten.io\/migrating-a-legacy-cloud-infrastructure-to-contrail-sdn-based-infrastructure\/","og_site_name":"Tungsten Fabric","article_published_time":"2016-07-11T22:17:57+00:00","og_image":[{"url":"http:\/\/www.opencontrail.org\/wp-content\/uploads\/2016\/07\/migration-to-EVPN_blogpost_image1.png"}],"author":"Vivekananda Shenoy","twitter_card":"summary_large_image","schema":{"@context":"https:\/\/schema.org","@graph":[{"@type":"WebPage","@id":"https:\/\/tungsten.io\/migrating-a-legacy-cloud-infrastructure-to-contrail-sdn-based-infrastructure\/","url":"https:\/\/tungsten.io\/migrating-a-legacy-cloud-infrastructure-to-contrail-sdn-based-infrastructure\/","name":"Migrating a legacy cloud infrastructure to Contrail SDN based infrastructure - Tungsten Fabric","isPartOf":{"@id":"https:\/\/tungsten.io\/#website"},"datePublished":"2016-07-11T22:17:57+00:00","dateModified":"2016-07-11T22:17:57+00:00","author":{"@id":"https:\/\/tungsten.io\/#\/schema\/person\/f9fb75fb71925ab248ee074c098c3b1b"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https:\/\/tungsten.io\/migrating-a-legacy-cloud-infrastructure-to-contrail-sdn-based-infrastructure\/"]}]},{"@type":"WebSite","@id":"https:\/\/tungsten.io\/#website","url":"https:\/\/tungsten.io\/","name":"Tungsten Fabric","description":"multicloud multistack SDN","potentialAction":[{"@type":"SearchAction","target":{"@type":"EntryPoint","urlTemplate":"https:\/\/tungsten.io\/?s={search_term_string}"},"query-input":"required name=search_term_string"}],"inLanguage":"en-US"},{"@type":"Person","@id":"https:\/\/tungsten.io\/#\/schema\/person\/f9fb75fb71925ab248ee074c098c3b1b","name":"Vivekananda Shenoy","image":{"@type":"ImageObject","inLanguage":"en-US","@id":"https:\/\/tungsten.io\/#\/schema\/person\/image\/","url":"https:\/\/secure.gravatar.com\/avatar\/7bf737562887a3a650fb532b763430a2?s=96&d=mm&r=pg","contentUrl":"https:\/\/secure.gravatar.com\/avatar\/7bf737562887a3a650fb532b763430a2?s=96&d=mm&r=pg","caption":"Vivekananda Shenoy"},"url":"https:\/\/tungsten.io"}]}},"_links":{"self":[{"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/posts\/7114"}],"collection":[{"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/users\/487"}],"replies":[{"embeddable":true,"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/comments?post=7114"}],"version-history":[{"count":0,"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/posts\/7114\/revisions"}],"wp:attachment":[{"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/media?parent=7114"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/categories?post=7114"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/tags?post=7114"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}