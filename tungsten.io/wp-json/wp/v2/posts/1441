{"id":1441,"date":"2014-04-23T20:45:22","date_gmt":"2014-04-23T20:45:22","guid":{"rendered":"http:\/\/opencontrail.org\/?p=1441"},"modified":"2014-04-23T20:45:22","modified_gmt":"2014-04-23T20:45:22","slug":"openstack-docker-opencontrail","status":"publish","type":"post","link":"https:\/\/tungsten.io\/openstack-docker-opencontrail\/","title":{"rendered":"OpenStack + Docker + OpenContrail"},"content":{"rendered":"<p style=\"color: #373737;\"><a style=\"font-weight: inherit; font-style: inherit; color: #1982d1;\" href=\"http:\/\/www.docker.io\/\">Docker<\/a>\u00a0is a tool that simplifies the process of building container images. One of the issues with OpenStack is that building glance images is an off-line process. It is often difficult to track the contents of the images, how they where created and what software they contain.<a style=\"font-weight: inherit; font-style: inherit; color: #1982d1;\" href=\"http:\/\/www.docker.io\/\">Docker<\/a>\u00a0also does not depend on virtualization; it creates linux container images that can be run directly by the host OS. This provides a much more efficient use of memory as well as better performance. It is a very attractive solution for DC operators\u00a0that run a private infrastructure that serves in-house developed applications.<\/p>\n<p><!--more Read more...--><\/p>\n<p style=\"color: #373737;\">In order to run\u00a0<a style=\"font-weight: inherit; font-style: inherit; color: #1982d1;\" href=\"http:\/\/www.docker.io\/\">Docker<\/a>\u00a0as an openstack \u201chypervisor\u201d start with devstack on ubuntu 12.04LTS. devstack includes a docker installer that will add a debian repository with the latest version of the docker packages.<\/p>\n<p style=\"color: #373737;\">After cloning the devstack repository one can issue the command:<\/p>\n<pre><span style=\"font-family: 'courier new', courier;\"><code>tools\/docker\/install_docker.sh<\/code><\/span><\/pre>\n<p style=\"color: #373737;\">For OpenContrail there isn\u2019t yet a similar install tool. I built the OpenContrail packages from source and installed them manually, modifying the configuration files in order to have config, control and compute-node components all running locally.<\/p>\n<p style=\"color: #373737;\">Next, I edited the devstack localrc file to have the following settings:<\/p>\n<pre><span style=\"font-family: 'courier new', courier;\"> localrc<\/span>\n<span style=\"font-family: 'courier new', courier;\"> <code>VIRT_DRIVER=docker\n disable_service n-net\n enable_service neutron\n enable_service q-svc\n Q_PLUGIN=contrail\n NEUTRON_REPO=<a href=\"https:\/\/github.com\/Juniper\/neutron.git\">https:\/\/github.com\/Juniper\/neutron.git<\/a>\n NEUTRON_BRANCH=contrail\/havana<\/code><\/span><\/pre>\n<p><span style=\"color: #373737;\">I also added the following file to devstack:<\/span><\/p>\n<pre><span style=\"font-family: 'courier new', courier;\"> lib\/neutron_plugins\/contrail<\/span>\n<span style=\"font-family: 'courier new', courier;\"> <code>functionhas_neutron_plugin_security_group() {\n return1\n }\n functionneutron_plugin_configure_common() {\n Q_PLUGIN_CONF_PATH=etc\/neutron\/plugins\/juniper\/contrail\n Q_PLUGIN_CONF_FILENAME=ContrailPlugin.ini\n Q_DB_NAME=neutron\n Q_PLUGIN_CLASS=neutron.plugins.juniper.contrail.contrailplugin.ContrailPlugin\n }\n functionneutron_plugin_configure_debug_command() {\n :\n }\n functionneutron_plugin_create_nova_conf() {\n NOVA_VIF_DRIVER=nova_contrail_vif.contrailvif.VRouterVIFDriver\n }\n functionneutron_plugin_configure_service() {\n iniset $NEUTRON_CONF quotas quota_driver neutron.quota.ConfDriver\n }\n functionneutron_plugin_setup_interface_driver() {\n :\n }\n functionneutron_plugin_check_adv_test_requirements() {\n return0\n }\n functionis_neutron_ovs_base_plugin() {\n return1\n }<\/code><\/span><\/pre>\n<p style=\"color: #373737;\">Unfortunately, the docker driver was moved out form the main nova code to stackforge. This requires the following change:<\/p>\n<pre><span style=\"font-family: 'courier new', courier;\"> lib\/nova_plugins\/hypervisor_docker<\/span>\n<span style=\"font-family: 'courier new', courier;\"> <code>diff --git a\/lib\/nova_plugins\/hypervisor-docker b\/lib\/nova_plugins\/hypervisor-docker\n index cdbc4d1..b4c1db9 100644\n --- a\/lib\/nova_plugins\/hypervisor-docker\n +++ b\/lib\/nova_plugins\/hypervisor-docker\n @@ -53,7 +53,8 @@ function cleanup_nova_hypervisor {\n # configure_nova_hypervisor - Set config files, create data dirs, etc\n function configure_nova_hypervisor {\n -\u00a0\u00a0\u00a0 iniset $NOVA_CONF DEFAULT compute_driver docker.DockerDriver\n +\u00a0\u00a0\u00a0 iniset $NOVA_CONF DEFAULT compute_driver novadocker.virt.docker.driver.DockerDriver\n iniset $GLANCE_API_CONF DEFAULT container_formats ami,ari,aki,bare,ovf,docker\n }<\/code><\/span><\/pre>\n<p style=\"color: #373737;\">The next step is to install the nova-docker package. The master branch is available at<a style=\"font-weight: inherit; font-style: inherit; color: #1982d1;\" href=\"https:\/\/github.com\/stackforge\/nova-docker\" rel=\"nofollow\">https:\/\/github.com\/stackforge\/nova-docker<\/a>. The fork that contains the opencontrail vif_driver is currently at\u00a0<a style=\"font-weight: inherit; font-style: inherit; color: #1982d1;\" href=\"https:\/\/github.com\/pedro-r-marques\/nova-docker.git\" rel=\"nofollow\">https:\/\/github.com\/pedro-r-marques\/nova-docker.git<\/a>\u00a0in the branch \u201copencontrail\u201d.<\/p>\n<p style=\"color: #373737;\">Before executing the nova-docker driver, i had create an extra rootwrap config file.<\/p>\n<pre><span style=\"font-family: 'courier new', courier;\"> \/etc\/nova\/rootwrap.d\/docker.filters<\/span>\n<span style=\"font-family: 'courier new', courier;\"> <code>[Filters]\n # novadocker\/virt\/docker\/driver.py: 'ln', '-sf'<\/code><\/span><\/pre>\n<p><span style=\"color: #373737;\">There is an additional change that needs to be performed. The nova configuration file requires following lines to execute the opencontrail vif_driver rather than the default:<\/span><\/p>\n<pre><span style=\"font-family: 'courier new', courier;\"> \/etc\/nova\/nova.conf<\/span>\n<span style=\"font-family: 'courier new', courier;\"> <code>[docker]\n vif_driver = novadocker.virt.docker.opencontrail.OpenContrailVIFDriver<\/code><\/span><\/pre>\n<p><span style=\"color: #373737;\">After this steps, you can execute\u00a0stack.sh\u00a0and boot an instance. The\u00a0stack.sh script creates a network called \u201cprivate\u201d. In order to start a docker container via nova one can issue the command:<\/span><\/p>\n<pre><span style=\"font-family: 'courier new', courier;\">nova boot --image {image-uuid} --nic net-id={network-uuid} --flavor 1 {image-name}<\/span><\/pre>\n<p style=\"color: #373737;\">And thats all folks!\u2026<\/p>\n<p style=\"color: #373737;\">If we take a peak at the\u00a0<a style=\"font-weight: inherit; font-style: inherit; color: #1982d1;\" href=\"https:\/\/github.com\/pedro-r-marques\/nova-docker\/blob\/opencontrail\/novadocker\/virt\/docker\/opencontrail.py\">vif_driver<\/a>\u00a0code above it is really striking how few lines of code are involved.<\/p>\n<p style=\"color: #373737;\">There is some additional work that needs to be done in the backend; the compute-node API that is used for nova, neutron, docker and netns provisioning needs to be extracted into a single library. That needs to be sorted out\u2026 more than anything else we need a simple tool to install opencontrail from a ppa.<\/p>\n<p style=\"color: #373737;\">But in my mind, docker + opencontrail are a great combination for clusters built to host internally developed applications such as is the case of SaaS providers. Entire application stacks can be deployed in minutes, at scale.<\/p>\n<p style=\"color: #373737;\">The only piece missing is a compute scheduler that is designed to manage the instant load of an application rather than virtual machines that come in \u201cflavor\u201d size increments of memory consumption.<\/p>\n","protected":false},"excerpt":{"rendered":"<p>Docker\u00a0is a tool that simplifies the process of building container images. One of the issues with OpenStack is that building glance images is an off-line process. It is often difficult&#8230;<\/p>\n","protected":false},"author":458,"featured_media":0,"comment_status":"open","ping_status":"closed","sticky":false,"template":"","format":"standard","meta":{"footnotes":""},"categories":[11,1],"tags":[],"acf":[],"yoast_head":"<!-- This site is optimized with the Yoast SEO plugin v21.6 - https:\/\/yoast.com\/wordpress\/plugins\/seo\/ -->\n<title>OpenStack + Docker + OpenContrail - Tungsten Fabric<\/title>\n<meta name=\"robots\" content=\"index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1\" \/>\n<link rel=\"canonical\" href=\"https:\/\/tungsten.io\/openstack-docker-opencontrail\/\" \/>\n<meta property=\"og:locale\" content=\"en_US\" \/>\n<meta property=\"og:type\" content=\"article\" \/>\n<meta property=\"og:title\" content=\"OpenStack + Docker + OpenContrail - Tungsten Fabric\" \/>\n<meta property=\"og:description\" content=\"Docker\u00a0is a tool that simplifies the process of building container images. One of the issues with OpenStack is that building glance images is an off-line process. It is often difficult...\" \/>\n<meta property=\"og:url\" content=\"https:\/\/tungsten.io\/openstack-docker-opencontrail\/\" \/>\n<meta property=\"og:site_name\" content=\"Tungsten Fabric\" \/>\n<meta property=\"article:published_time\" content=\"2014-04-23T20:45:22+00:00\" \/>\n<meta name=\"author\" content=\"Pedro Marques\" \/>\n<meta name=\"twitter:card\" content=\"summary_large_image\" \/>\n<script type=\"application\/ld+json\" class=\"yoast-schema-graph\">{\"@context\":\"https:\/\/schema.org\",\"@graph\":[{\"@type\":\"WebPage\",\"@id\":\"https:\/\/tungsten.io\/openstack-docker-opencontrail\/\",\"url\":\"https:\/\/tungsten.io\/openstack-docker-opencontrail\/\",\"name\":\"OpenStack + Docker + OpenContrail - Tungsten Fabric\",\"isPartOf\":{\"@id\":\"https:\/\/tungsten.io\/#website\"},\"datePublished\":\"2014-04-23T20:45:22+00:00\",\"dateModified\":\"2014-04-23T20:45:22+00:00\",\"author\":{\"@id\":\"https:\/\/tungsten.io\/#\/schema\/person\/4482c87f5bb06e7236ba1ff004df8def\"},\"inLanguage\":\"en-US\",\"potentialAction\":[{\"@type\":\"ReadAction\",\"target\":[\"https:\/\/tungsten.io\/openstack-docker-opencontrail\/\"]}]},{\"@type\":\"WebSite\",\"@id\":\"https:\/\/tungsten.io\/#website\",\"url\":\"https:\/\/tungsten.io\/\",\"name\":\"Tungsten Fabric\",\"description\":\"multicloud multistack SDN\",\"potentialAction\":[{\"@type\":\"SearchAction\",\"target\":{\"@type\":\"EntryPoint\",\"urlTemplate\":\"https:\/\/tungsten.io\/?s={search_term_string}\"},\"query-input\":\"required name=search_term_string\"}],\"inLanguage\":\"en-US\"},{\"@type\":\"Person\",\"@id\":\"https:\/\/tungsten.io\/#\/schema\/person\/4482c87f5bb06e7236ba1ff004df8def\",\"name\":\"Pedro Marques\",\"image\":{\"@type\":\"ImageObject\",\"inLanguage\":\"en-US\",\"@id\":\"https:\/\/tungsten.io\/#\/schema\/person\/image\/\",\"url\":\"https:\/\/secure.gravatar.com\/avatar\/6e92702fd500d2259b81e6285c050e68?s=96&d=mm&r=pg\",\"contentUrl\":\"https:\/\/secure.gravatar.com\/avatar\/6e92702fd500d2259b81e6285c050e68?s=96&d=mm&r=pg\",\"caption\":\"Pedro Marques\"},\"url\":\"https:\/\/tungsten.io\"}]}<\/script>\n<!-- \/ Yoast SEO plugin. -->","yoast_head_json":{"title":"OpenStack + Docker + OpenContrail - Tungsten Fabric","robots":{"index":"index","follow":"follow","max-snippet":"max-snippet:-1","max-image-preview":"max-image-preview:large","max-video-preview":"max-video-preview:-1"},"canonical":"https:\/\/tungsten.io\/openstack-docker-opencontrail\/","og_locale":"en_US","og_type":"article","og_title":"OpenStack + Docker + OpenContrail - Tungsten Fabric","og_description":"Docker\u00a0is a tool that simplifies the process of building container images. One of the issues with OpenStack is that building glance images is an off-line process. It is often difficult...","og_url":"https:\/\/tungsten.io\/openstack-docker-opencontrail\/","og_site_name":"Tungsten Fabric","article_published_time":"2014-04-23T20:45:22+00:00","author":"Pedro Marques","twitter_card":"summary_large_image","schema":{"@context":"https:\/\/schema.org","@graph":[{"@type":"WebPage","@id":"https:\/\/tungsten.io\/openstack-docker-opencontrail\/","url":"https:\/\/tungsten.io\/openstack-docker-opencontrail\/","name":"OpenStack + Docker + OpenContrail - Tungsten Fabric","isPartOf":{"@id":"https:\/\/tungsten.io\/#website"},"datePublished":"2014-04-23T20:45:22+00:00","dateModified":"2014-04-23T20:45:22+00:00","author":{"@id":"https:\/\/tungsten.io\/#\/schema\/person\/4482c87f5bb06e7236ba1ff004df8def"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https:\/\/tungsten.io\/openstack-docker-opencontrail\/"]}]},{"@type":"WebSite","@id":"https:\/\/tungsten.io\/#website","url":"https:\/\/tungsten.io\/","name":"Tungsten Fabric","description":"multicloud multistack SDN","potentialAction":[{"@type":"SearchAction","target":{"@type":"EntryPoint","urlTemplate":"https:\/\/tungsten.io\/?s={search_term_string}"},"query-input":"required name=search_term_string"}],"inLanguage":"en-US"},{"@type":"Person","@id":"https:\/\/tungsten.io\/#\/schema\/person\/4482c87f5bb06e7236ba1ff004df8def","name":"Pedro Marques","image":{"@type":"ImageObject","inLanguage":"en-US","@id":"https:\/\/tungsten.io\/#\/schema\/person\/image\/","url":"https:\/\/secure.gravatar.com\/avatar\/6e92702fd500d2259b81e6285c050e68?s=96&d=mm&r=pg","contentUrl":"https:\/\/secure.gravatar.com\/avatar\/6e92702fd500d2259b81e6285c050e68?s=96&d=mm&r=pg","caption":"Pedro Marques"},"url":"https:\/\/tungsten.io"}]}},"_links":{"self":[{"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/posts\/1441"}],"collection":[{"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/users\/458"}],"replies":[{"embeddable":true,"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/comments?post=1441"}],"version-history":[{"count":0,"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/posts\/1441\/revisions"}],"wp:attachment":[{"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/media?parent=1441"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/categories?post=1441"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/tungsten.io\/wp-json\/wp\/v2\/tags?post=1441"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}